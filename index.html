<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOKO - AI လိုဂို ဖန်တီးရန်</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Pacifico&family=Oswald:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Padauk', sans-serif;
            background-color: #f3f4f6;
        }
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 40px;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.375rem; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <!-- Header / Navigation -->
    <header class="bg-indigo-600 text-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between py-4">
                <div class="flex items-center space-x-2">
                    <span class="text-3xl">✨</span>
                    <h1 class="text-3xl font-extrabold tracking-wider">SOKO</h1>
                </div>
                <nav class="mt-4 md:mt-0 flex space-x-6 text-sm font-semibold">
                    <button id="navHome" class="pb-1 border-b-2 border-white hover:text-indigo-200 transition">မူလစာမျက်နှာ</button>
                    <button id="navCreate" class="pb-1 border-b-2 border-transparent hover:text-indigo-200 transition">အသစ်ဖန်တီးမည်</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <!-- ================= HOME VIEW ================= -->
        <div id="homeView" class="space-y-12 animate-fade-in">
            <div class="text-center py-16 bg-white rounded-2xl shadow-sm border border-gray-200 px-4">
                <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">SOKO မှ ကြိုဆိုပါသည်</h2>
                <p class="text-gray-600 mb-8 max-w-2xl mx-auto text-lg">သင့်လုပ်ငန်းနှင့် အမှတ်တံဆိပ်အတွက် ထူးခြားဆန်းသစ်သော လိုဂိုများကို AI နည်းပညာဖြင့် အလွယ်တကူ ဖန်တီးသိမ်းဆည်းလိုက်ပါ။</p>
                <button id="startCreateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-full shadow-lg transform transition hover:scale-105 text-lg">
                    စတင် ဖန်တီးမည်
                </button>
            </div>

            <div>
                <div class="flex items-center justify-between mb-6 border-b pb-2">
                    <h3 class="text-2xl font-bold text-gray-800">မိမိဖန်တီးထားသော လိုဂိုများ</h3>
                    <span class="text-sm text-gray-500" id="logoCount">စုစုပေါင်း: ၀ ပုံ</span>
                </div>
                <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>

        <!-- ================= EDITOR VIEW ================= -->
        <div id="editorView" class="hidden flex-col lg:flex-row gap-8 items-start">
            
            <!-- Left Panel: Controls -->
            <div class="w-full lg:w-1/3 space-y-6">
                
                <!-- AI Generation Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 space-y-4 border-t-4 border-indigo-500">
                    <h2 class="text-xl font-bold border-b pb-2 text-indigo-700">🤖 AI ဖြင့် ဖန်တီးမည်</h2>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ပုံကြမ်း (Sketch) <span class="text-xs text-gray-400 font-normal">(မထည့်လည်းရသည်)</span></label>
                        <input type="file" id="sketchInput" accept="image/*" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                        <img id="sketchPreview" class="mt-2 hidden max-h-32 rounded border border-gray-200 mx-auto" alt="Sketch Preview">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ဒီဇိုင်း စတိုင် (Style)</label>
                        <select id="aiStyle" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                            <option value="flat minimalist vector art, solid background">ရိုးရှင်းသော (Minimalist)</option>
                            <option value="3D rendered, highly detailed, glossy">3D ပုံစံ (3D Render)</option>
                            <option value="cute mascot character, vibrant colors">ကာတွန်း/အရုပ် (Mascot)</option>
                            <option value="vintage retro hand-drawn badge">ရှေးဟောင်း (Vintage)</option>
                            <option value="neon cyberpunk glowing logo, dark background">နီယွန်မီးရောင် (Neon)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">စိတ်ကြိုက် ပုံစံရေးပြရန် (Prompt)</label>
                        <textarea id="aiPrompt" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-sans text-sm" placeholder="ဥပမာ - Blue and white color scheme, focus on a bird looking up"></textarea>
                    </div>

                    <button id="generateAiBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow transition flex justify-center items-center gap-2">
                        <span>AI ဖြင့် ဖန်တီးမည်</span>
                    </button>
                    
                    <div id="aiLoading" class="hidden flex items-center justify-center space-x-2 text-indigo-600 font-semibold py-2">
                        <div class="loader"></div>
                        <span>ဖန်တီးနေပါသည်... စောင့်ပါ...</span>
                    </div>
                    
                    <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm" role="alert">
                        <span class="block sm:inline" id="errorText"></span>
                    </div>

                    <button id="clearAiBtn" class="hidden w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-md shadow transition text-sm">
                        AI ပုံကို ဖျက်မည်
                    </button>
                </div>

                <!-- Standard Controls Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 space-y-4">
                    <h2 class="text-xl font-bold border-b pb-2">စာသားနှင့် အရောင် ပြင်ဆင်ရန်</h2>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">လိုဂို စာသား</label>
                        <input type="text" id="logoText" value="SOKO Brand" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-sans">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ဖောင့် အမျိုးအစား</label>
                        <select id="fontFamily" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="Montserrat, sans-serif">Montserrat (Modern)</option>
                            <option value="Pacifico, cursive">Pacifico (Handwriting)</option>
                            <option value="Oswald, sans-serif">Oswald (Bold/Impact)</option>
                            <option value="Playfair Display, serif">Playfair Display (Elegant)</option>
                            <option value="Arial, sans-serif">Arial (Basic)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">သင်္ကေတ (Icon)</label>
                        <select id="iconType" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                            <option value="none" selected>မထည့်ပါ</option>
                            <option value="diamond">💎 စိန်</option>
                            <option value="star">⭐ ကြယ်</option>
                            <option value="leaf">🍃 သစ်ရွက်</option>
                            <option value="rocket">🚀 ဒုံးပျံ</option>
                            <option value="coffee">☕ ကော်ဖီ</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">စာသား အရောင်</label>
                            <input type="color" id="textColor" value="#1f2937">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">နောက်ခံ အရောင်</label>
                            <input type="color" id="bgColor" value="#ffffff">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Preview -->
            <div class="w-full lg:w-2/3 flex flex-col items-center space-y-6">
                <div class="w-full bg-white rounded-xl shadow-lg p-4 flex flex-col items-center justify-center min-h-[400px] relative overflow-hidden">
                    <p class="absolute top-4 left-4 text-xs text-gray-400 font-semibold uppercase tracking-widest">Preview (နမူနာ)</p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 shadow-sm bg-gray-50 relative">
                        <canvas id="logoCanvas" width="1024" height="1024" class="w-[300px] h-[300px] sm:w-[400px] sm:h-[400px] rounded object-contain shadow-sm bg-white"></canvas>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row w-full gap-4 px-4 lg:px-0">
                    <button id="downloadBtn" class="flex-1 border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50 font-bold py-3 px-6 rounded-full shadow transition flex justify-center items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>ပုံကို ဒေါင်းလုဒ်ဆွဲမည်</span>
                    </button>
                    
                    <button id="saveGalleryBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition hover:scale-105 flex justify-center items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        <span>SOKO ပြခန်းသို့ သိမ်းမည်</span>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 text-center py-6 mt-auto">
        <p class="text-sm">© 2026 SOKO AI Logo Maker. All rights reserved.</p>
    </footer>

    <!-- Toast & Modals -->
    <div id="toast" class="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-3 rounded-lg shadow-2xl transform transition-all duration-300 translate-y-20 opacity-0 z-50 flex items-center space-x-2">
        <span id="toastMsg">အောင်မြင်ပါသည်!</span>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-xl font-bold mb-2 text-gray-800">ဖျက်ရန် သေချာပါသလား?</h3>
            <p class="text-gray-600 mb-6 text-sm">ဤလိုဂိုကို ဖျက်လိုက်ပါက ပြန်လည်ရယူ၍ မရနိုင်ပါ။</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-semibold transition">မလုပ်တော့ပါ</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition">ဖျက်မည်</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        (function() {
            // Updated New API Key
            const apiKey = "AIzaSyC2PGcoNymNRoTu8z69dxsoP6PjNyb0P2U"; 
            const sokoStorageKey = 'soko_saved_logos';

            function initApp() {
                const canvas = document.getElementById('logoCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                const homeView = document.getElementById('homeView');
                const editorView = document.getElementById('editorView');
                const navHome = document.getElementById('navHome');
                const navCreate = document.getElementById('navCreate');
                const startCreateBtn = document.getElementById('startCreateBtn');
                
                const logoTextInput = document.getElementById('logoText');
                const fontFamilyInput = document.getElementById('fontFamily');
                const iconTypeInput = document.getElementById('iconType');
                const textColorInput = document.getElementById('textColor');
                const bgColorInput = document.getElementById('bgColor');
                const downloadBtn = document.getElementById('downloadBtn');
                const saveGalleryBtn = document.getElementById('saveGalleryBtn');

                const sketchInput = document.getElementById('sketchInput');
                const sketchPreview = document.getElementById('sketchPreview');
                const aiStyleInput = document.getElementById('aiStyle');
                const aiPromptInput = document.getElementById('aiPrompt');
                const generateAiBtn = document.getElementById('generateAiBtn');
                const aiLoading = document.getElementById('aiLoading');
                const errorBox = document.getElementById('errorBox');
                const errorText = document.getElementById('errorText');
                const clearAiBtn = document.getElementById('clearAiBtn');

                let uploadedBase64 = null;
                let uploadedMimeType = null;
                let aiGeneratedImage = null;
                let logoToDelete = null;

                const iconMap = {
                    'diamond': '💎', 'star': '⭐', 'leaf': '🍃', 
                    'rocket': '🚀', 'coffee': '☕'
                };

                function showHome() {
                    homeView.classList.remove('hidden');
                    editorView.classList.remove('flex');
                    editorView.classList.add('hidden');
                    navHome.classList.replace('border-transparent', 'border-white');
                    navCreate.classList.replace('border-white', 'border-transparent');
                    renderGallery();
                }

                function showEditor() {
                    homeView.classList.add('hidden');
                    editorView.classList.remove('hidden');
                    editorView.classList.add('flex');
                    navCreate.classList.replace('border-transparent', 'border-white');
                    navHome.classList.replace('border-white', 'border-transparent');
                    drawLogo();
                }

                navHome.addEventListener('click', showHome);
                navCreate.addEventListener('click', showEditor);
                startCreateBtn.addEventListener('click', showEditor);

                function showToast(msg, isError = false) {
                    const toast = document.getElementById('toast');
                    const toastMsg = document.getElementById('toastMsg');
                    toastMsg.textContent = msg;
                    if(isError) {
                        toast.classList.replace('bg-green-600', 'bg-red-600');
                    } else {
                        toast.classList.replace('bg-red-600', 'bg-green-600');
                    }
                    toast.classList.remove('translate-y-20', 'opacity-0');
                    setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
                }

                window.requestDelete = function(id) {
                    logoToDelete = id;
                    document.getElementById('confirmModal').classList.remove('hidden');
                };

                window.downloadSavedLogo = async function(id) {
                    const logos = JSON.parse(localStorage.getItem(sokoStorageKey) || '[]');
                    const logo = logos.find(l => l.id === id);
                    if (logo) {
                        try {
                            const res = await fetch(logo.image);
                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${logo.name}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        } catch (e) {
                            const link = document.createElement('a');
                            link.href = logo.image;
                            link.download = `${logo.name}.png`;
                            link.click();
                        }
                    }
                };

                document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                    logoToDelete = null;
                    document.getElementById('confirmModal').classList.add('hidden');
                });

                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    if (logoToDelete) {
                        let logos = JSON.parse(localStorage.getItem(sokoStorageKey) || '[]');
                        logos = logos.filter(l => l.id !== logoToDelete);
                        localStorage.setItem(sokoStorageKey, JSON.stringify(logos));
                        document.getElementById('confirmModal').classList.add('hidden');
                        logoToDelete = null;
                        renderGallery();
                        showToast('ပြခန်းမှ ဖျက်ပစ်လိုက်ပါပြီ။');
                    }
                });

                function renderGallery() {
                    const grid = document.getElementById('galleryGrid');
                    const countLabel = document.getElementById('logoCount');
                    const logos = JSON.parse(localStorage.getItem(sokoStorageKey) || '[]');
                    
                    countLabel.textContent = `စုစုပေါင်း: ${logos.length} ပုံ`;

                    if (logos.length === 0) {
                        grid.innerHTML = `
                            <div class="col-span-full py-16 text-center bg-white rounded-xl border border-dashed border-gray-300">
                                <span class="text-4xl block mb-2">📭</span>
                                <p class="text-gray-500 font-semibold">သိမ်းဆည်းထားသော လိုဂို မရှိသေးပါ။</p>
                                <button onclick="document.getElementById('navCreate').click()" class="mt-4 text-indigo-600 hover:underline">ယခုပင် စတင်ဖန်တီးမည်</button>
                            </div>`;
                        return;
                    }

                    grid.innerHTML = logos.map(logo => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition relative group flex flex-col">
                            <div class="w-full aspect-square bg-gray-50 rounded-lg border border-gray-100 flex items-center justify-center p-2 mb-3">
                                <img src="${logo.image}" alt="${logo.name}" class="max-w-full max-h-full object-contain">
                            </div>
                            <div class="flex justify-between items-start mb-2">
                                <div class="overflow-hidden">
                                    <h4 class="font-bold text-gray-800 truncate" title="${logo.name}">${logo.name}</h4>
                                    <p class="text-xs text-gray-400">${logo.date}</p>
                                </div>
                                <button onclick="requestDelete(${logo.id})" class="text-gray-400 hover:text-red-500 transition p-1" title="ဖျက်မည်">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <button onclick="downloadSavedLogo(${logo.id})" class="mt-auto block w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-center font-semibold py-2 rounded transition">
                                ဒေါင်းလုဒ်
                            </button>
                        </div>
                    `).reverse().join('');
                }

                function drawLogo() {
                    const text = logoTextInput.value;
                    const font = fontFamilyInput.value;
                    const iconType = iconTypeInput.value;
                    const textColor = textColorInput.value;
                    const bgColor = bgColorInput.value;

                    const width = canvas.width;
                    const height = canvas.height;
                    const centerX = width / 2;
                    const centerY = height / 2;

                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, width, height);

                    if (aiGeneratedImage) {
                        const scale = Math.min(width / aiGeneratedImage.width, height / aiGeneratedImage.height);
                        const drawWidth = aiGeneratedImage.width * scale;
                        const drawHeight = aiGeneratedImage.height * scale;
                        const x = (width / 2) - (drawWidth / 2);
                        const y = (height / 2) - (drawHeight / 2);
                        ctx.drawImage(aiGeneratedImage, x, y, drawWidth, drawHeight);
                    } else {
                        let iconText = iconType !== 'none' ? iconMap[iconType] : '';
                        if (iconText) {
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.font = `200px Arial`;
                            ctx.fillText(iconText, centerX, centerY - 60);
                        }
                    }

                    if (text.trim() !== '') {
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const sizeBase = 120;
                        ctx.font = `bold ${sizeBase}px ${font}`;
                        
                        ctx.shadowColor = "rgba(255, 255, 255, 0.9)";
                        ctx.shadowBlur = 15;
                        
                        ctx.fillStyle = textColor;
                        const yPos = aiGeneratedImage ? height - 120 : centerY + 100;
                        ctx.fillText(text, centerX, yPos);
                        
                        ctx.shadowBlur = 0; 
                    }
                }

                const inputs = [logoTextInput, fontFamilyInput, iconTypeInput, textColorInput, bgColorInput];
                inputs.forEach(input => {
                    input.addEventListener('input', drawLogo);
                    input.addEventListener('change', drawLogo);
                });

                sketchInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        uploadedBase64 = null;
                        sketchPreview.classList.add('hidden');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const MAX_SIZE = 768;
                            let w = img.width;
                            let h = img.height;
                            if (w > MAX_SIZE || h > MAX_SIZE) {
                                const ratio = Math.min(MAX_SIZE / w, MAX_SIZE / h);
                                w *= ratio;
                                h *= ratio;
                            }
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = w;
                            tempCanvas.height = h;
                            const tCtx = tempCanvas.getContext('2d');
                            
                            tCtx.fillStyle = '#ffffff';
                            tCtx.fillRect(0, 0, w, h);
                            tCtx.drawImage(img, 0, 0, w, h);
                            
                            uploadedMimeType = 'image/jpeg';
                            const dataUrl = tempCanvas.toDataURL('image/jpeg', 0.85);
                            uploadedBase64 = dataUrl.split(',')[1];
                            sketchPreview.src = dataUrl;
                            sketchPreview.classList.remove('hidden');
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });

                clearAiBtn.addEventListener('click', () => {
                    aiGeneratedImage = null;
                    clearAiBtn.classList.add('hidden');
                    drawLogo();
                });

                async function fetchWithBackoff(url, options, maxRetries = 3) {
                    let retries = 0;
                    const delays = [1000, 2000, 4000];
                    while (true) {
                        try {
                            const response = await fetch(url, options);
                            let data;
                            try {
                                data = await response.json();
                            } catch (e) {
                                throw new Error(`ဆာဗာ ချို့ယွင်းချက် (Status: ${response.status})`);
                            }
                            
                            if (!response.ok) {
                                if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                                    throw new Error(data.error?.message || `Error: ${response.status}`);
                                }
                                throw new Error(data.error?.message || `HTTP error! status: ${response.status}`);
                            }
                            return data;
                        } catch (error) {
                            if (retries >= maxRetries || error.message.includes("Error: 400") || error.message.includes("Error: 403")) {
                                throw error;
                            }
                            await new Promise(resolve => setTimeout(resolve, delays[retries]));
                            retries++;
                        }
                    }
                }

                generateAiBtn.addEventListener('click', async () => {
                    if (!uploadedBase64 && !aiPromptInput.value.trim()) {
                        showError("ကျေးဇူးပြု၍ ပုံကြမ်း (Sketch) သို့မဟုတ် စိတ်ကြိုက် ပုံစံ (Prompt) တစ်ခုခု ထည့်သွင်းပေးပါ။");
                        return;
                    }

                    hideError();
                    generateAiBtn.disabled = true;
                    generateAiBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    aiLoading.classList.remove('hidden');

                    const userPrompt = aiPromptInput.value || "Make it professional and high quality.";
                    const selectedStyle = aiStyleInput.value;
                    
                    try {
                        let sketchDesc = "";
                        
                        // အဆင့် ၁: ပုံကြမ်း (Sketch) ပါဝင်ပါက Gemini 1.5 Flash ဖြင့် ပုံကိုဖတ်ရှုခိုင်းခြင်း
                        if (uploadedBase64) {
                            try {
                                const visionUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                                const visionPayload = {
                                    contents: [{
                                        parts: [
                                            { text: "Briefly describe the main object, shape, and layout of this sketch. Ignore text. Focus only on the visual concept for a logo." },
                                            { inlineData: { mimeType: uploadedMimeType, data: uploadedBase64 } }
                                        ]
                                    }]
                                };
                                
                                const vRes = await fetchWithBackoff(visionUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(visionPayload)
                                });
                                sketchDesc = vRes.candidates?.[0]?.content?.parts?.[0]?.text || "";
                            } catch(e) {
                                console.warn("ပုံကြမ်းဖတ်ရှုခြင်း အခက်အခဲဖြစ်ပါသည်၊ Prompt ဖြင့်သာ ဆက်လက်ဖန်တီးပါမည်။", e);
                            }
                        }

                        // အဆင့် ၂: Public API တွင်ရရှိနိုင်သော Imagen 3 ကို အသုံးပြု၍ လိုဂိုပုံ ဖန်တီးခြင်း
                        const fullPrompt = `Create a masterpiece, highly detailed, professional logo design. Style: ${selectedStyle}. User Request: ${userPrompt}. ${sketchDesc ? 'The logo must feature this concept: ' + sketchDesc : ''} IMPORTANT STRICT RULES: The image MUST be a centered logo, isolated on a clean solid white background, award-winning quality, and absolutely NO text inside the generated logo symbol.`;
                        
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`;
                        const payload = {
                            instances: [{ prompt: fullPrompt }],
                            parameters: { sampleCount: 1, aspectRatio: "1:1" }
                        };

                        const result = await fetchWithBackoff(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const generatedBase64 = result.predictions?.[0]?.bytesBase64Encoded;
                        const mimeType = result.predictions?.[0]?.mimeType || "image/jpeg";

                        if (generatedBase64) {
                            const img = new Image();
                            img.onload = () => {
                                aiGeneratedImage = img;
                                clearAiBtn.classList.remove('hidden');
                                drawLogo();
                                generateAiBtn.disabled = false;
                                generateAiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                aiLoading.classList.add('hidden');
                            };
                            img.onerror = () => { 
                                showError("AI မှ ပုံဖော်ပြရာတွင် အခက်အခဲရှိနေပါသည်။"); 
                                generateAiBtn.disabled = false;
                                generateAiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                aiLoading.classList.add('hidden');
                            };
                            img.src = `data:${mimeType};base64,${generatedBase64}`;
                        } else {
                            throw new Error("ပုံဖန်တီးခြင်း မအောင်မြင်ပါ။ နောက်တစ်ကြိမ် ထပ်ကြိုးစားကြည့်ပါ။");
                        }
                    } catch (error) {
                        showError(error.message || "အင်တာနက် သို့မဟုတ် ဆာဗာ ချို့ယွင်းချက်ဖြစ်ပွားနေပါသည်။");
                        generateAiBtn.disabled = false;
                        generateAiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        aiLoading.classList.add('hidden');
                    }
                });

                function showError(msg) {
                    errorText.textContent = msg;
                    errorBox.classList.remove('hidden');
                }
                function hideError() {
                    errorBox.classList.add('hidden');
                    errorText.textContent = "";
                }

                downloadBtn.addEventListener('click', async () => {
                    const filename = `${logoTextInput.value.trim() || 'soko-logo'}.png`;
                    const dataUrl = canvas.toDataURL('image/png', 1.0);
                    
                    try {
                        const res = await fetch(dataUrl);
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = dataUrl;
                        link.click();
                    }
                });

                saveGalleryBtn.addEventListener('click', () => {
                    const dataUrl = canvas.toDataURL('image/png');
                    const name = logoTextInput.value.trim() || 'SOKO Logo';
                    const logos = JSON.parse(localStorage.getItem(sokoStorageKey) || '[]');
                    const dateStr = new Date().toLocaleDateString('my-MM', { year: 'numeric', month: 'short', day: 'numeric' });

                    logos.push({
                        id: Date.now(),
                        name: name,
                        image: dataUrl,
                        date: dateStr
                    });

                    try {
                        localStorage.setItem(sokoStorageKey, JSON.stringify(logos));
                        showToast('SOKO ပြခန်းသို့ အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ!');
                        setTimeout(showHome, 1000);
                    } catch (e) {
                        showToast('Storage ပြည့်နေပါသည်။ ပြခန်းမှ အဟောင်းများကို အရင်ဖျက်ပေးပါ။', true);
                    }
                });

                drawLogo();
                setTimeout(drawLogo, 500);
                renderGallery();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApp);
            } else {
                initApp();
            }
        })();
    </script>
</body>
</html>


